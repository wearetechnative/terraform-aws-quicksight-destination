# Setup Receiving S3 Bucket and Optionally Enabling AWS Cost and Usage Reports (CUR) with Terraform

This Terraform configuration is designed to set up a receiving S3 bucket and optionally enable AWS Cost and Usage Reports (CUR) by configuring the necessary IAM roles and policies. The setup ensures secure storage, replication, and access to your CUR data for analysis in a destination account.

## Prerequisites

Before you begin, ensure you have the following:

- **Terraform** installed on your local machine or server.
- **AWS CLI** configured with credentials that have sufficient permissions to create S3 buckets, IAM roles, and CUR reports.
- **AWS Account** with permissions to create resources such as S3 buckets, IAM roles, and CUR reports.
- **KMS Key**: If you intend to use server-side encryption with AWS KMS, ensure you have the KMS key ID ready.

## Files Included

This configuration includes the following Terraform files:

- **`main.tf`**: Contains the primary resources for setting up the S3 bucket, IAM roles, and CUR report definition.
- **`variables.tf`**: Defines the input variables required for the Terraform configuration.
- **`outputs.tf`**: Specifies the outputs generated by the Terraform configuration.
- **`versions.tf`**: Specifies the required Terraform and provider versions.
- **`README.md`**: Documentation for the Terraform configuration.

## Terraform Variables

This configuration uses several variables that you must define before applying the configuration. Below is a description of each variable:

- **`source_account_ids`**: A list of AWS account IDs that will be sending CUR data to this bucket.
- **`create_cur`**: Boolean to determine whether to create an additional CUR in the aggregation account.
- **`resource_prefix`**: A prefix that will be used to name the resources, such as the S3 bucket.
- **`kms_key_id`**: The KMS key ID used for server-side encryption (optional).
- **`tags`**: Tags to apply to the created resources.
- **`s3_access_logging`**: A map containing `enabled`, `bucket`, and `prefix` for S3 access logging configuration.

These variables can be defined in a `terraform.tfvars` file or passed directly via the command line when running Terraform.

### Example `terraform.tfvars`

```hcl
resource_prefix = "TechNative"
kms_key_id = "arn:aws:kms:us-east-1:123456789012:key/your-kms-key-id"
tags = {
  Environment = "Production"
  Owner       = "Finance"
}

s3_access_logging = {
  enabled = true
  bucket  = "my-logging-bucket"
  prefix  = "logs/"
}

source_account_ids = ["123456789012"] # Change to sending accounts
create_cur         = false # Set to true to create an additional CUR in the aggregation account
```

## Usage

1. **Clone the Repository**

   Clone this repository to your local machine using SSH:

   ```bash
   git clone git@github.com:wearetechnative/terraform-aws-quicksight-destination.git
   cd terraform-aws-quicksight-destination
   ```

2. **Initialize Terraform**

   Initialize the Terraform configuration by running:

   ```bash
   terraform init
   ```

3. **Plan the Terraform Deployment**

   Generate an execution plan with the following command:

   ```bash
   terraform plan
   ```

   Review the plan to ensure that it matches your expectations.

4. **Apply the Terraform Deployment**

   Apply the Terraform configuration to create the resources:

   ```bash
   terraform apply
   ```

   Confirm the prompt with `yes` to proceed with resource creation.

5. **Verify the Resources**

   After Terraform completes, you can verify the creation of the S3 bucket, IAM roles, and other resources through the AWS Management Console or by using the AWS CLI.

   ```bash
   aws s3 ls
   aws iam list-roles
   ```

6. **Check Cost and Usage Reports (CUR)**

   If you have enabled CUR creation, navigate to the AWS Billing Console to ensure that the CUR report is generated and saved in the S3 bucket as expected.

7. **Cleanup (Optional)**

   If you ever need to remove the resources created by this Terraform configuration, you can run:

   ```bash
   terraform destroy
   ```

   Confirm the prompt with `yes` to remove the resources.

## Security Considerations

- **KMS Encryption**: This configuration supports KMS encryption for the S3 bucket. Ensure that your KMS key has the appropriate permissions for the S3 bucket.
- **Bucket Policies**: The S3 bucket policy restricts access to TLS 1.2 and HTTPS only, which is crucial for securing data in transit.
- **Access Logging**: Enabling access logging on the S3 bucket is recommended to track and audit access to your bucket.

## Example Configuration

Below is an example configuration for using this module with the necessary providers:

```hcl
provider "aws" {
  profile = "data_collection"
  region  = "eu-central-1"
  alias   = "data_collection"
}

provider "aws" {
  region = "us-east-1"
  alias  = "useast1"
}

module "cur_data_collection_account" {
  source = "./destination/"

  source_account_ids = ["123456789012"] # Change to sending accounts 
  create_cur         = false # Set to true to create an additional CUR in the aggregation account

  providers = {
    aws.useast1 = aws.useast1
  }
}
```

## Outputs

After applying this Terraform configuration, the following outputs will be available:

- **`s3_bucket_id`**: The ID of the S3 bucket created for CUR.
- **`iam_role_arn`**: The ARN of the IAM role created for S3 replication.

## Troubleshooting

- **Access Denied Errors**: Ensure that your AWS credentials have sufficient permissions to create and manage the resources defined in this Terraform configuration.
- **KMS Key Issues**: If using KMS encryption, verify that the key exists and that your IAM roles have the correct permissions to use the key.